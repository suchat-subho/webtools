<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8" />
<title>Mini WebRTC (<60 chars)</title>
<style>
body { font-family: sans-serif; padding: 20px; }
#qr { margin-top: 20px; }
textarea { width: 100%; height: 60px; }
#tinyStr { margin-top: 10px; font-size: 18px; font-weight: bold; }
#charCount { font-weight: bold; }
</style>
</head>
<body>

<h2>Mini WebRTC Connect (<60 chars)</h2>

<button id="hostBtn">Start Host</button>
<button id="joinBtn">Start Join</button>

<div id="qr"></div>
<div id="tinyStr"></div>
<div id="charCount"></div>

<h3>Paste Connection String</h3>
<textarea id="remoteStr"></textarea><br>
<button id="applyBtn">Apply</button>

<!-- pako for DEFLATE -->
<script src="https://cdn.jsdelivr.net/npm/pako@2.1.0/dist/pako.min.js"></script>
<!-- QR -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

<script>
/* ---------- Z85 Encoding (ZeroMQ spec) ---------- */
const Z85 = {
    encoder: (data) => {
        const chars =
"0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ.-:+=^!/*?&<>()[]{}@%$#";
        let str = "";
        let value = 0;
        for (let i = 0; i < data.length; i++) {
            value = value * 256 + data[i];
            if (i % 4 === 3) {
                let divisor = 85 * 85 * 85 * 85;
                for (let j = 0; j < 5; j++) {
                    str += chars[Math.floor(value / divisor) % 85];
                    divisor /= 85;
                }
                value = 0;
            }
        }
        return str;
    },
    decoder: (str) => {
        const chars =
"0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ.-:+=^!/*?&<>()[]{}@%$#";
        const data = [];
        let value = 0;
        for (let i = 0; i < str.length; i++) {
            value = value * 85 + chars.indexOf(str[i]);
            if (i % 5 === 4) {
                let divisor = 256 * 256 * 256;
                for (let j = 0; j < 4; j++) {
                    data.push((value / divisor) >> 0);
                    value %= divisor;
                    divisor /= 256;
                }
                value = 0;
            }
        }
        return new Uint8Array(data);
    }
};

/* -------- Minimal SDP Templates -------- */
function buildOfferSDP(u, p, c) {
return `v=0
o=- 1 2 IN IP4 0.0.0.0
s=-
t=0 0
a=ice-options:trickle
a=ice-ufrag:${u}
a=ice-pwd:${p}
m=application 9 DTLS/SCTP 5000
a=candidate:${c}`;
}
function buildAnswerSDP(u, p, c) {
return buildOfferSDP(u, p, c);
}

/* -------- Compression using DEFLATE + Z85 -------- */
function compressTiny(obj) {
    const json = JSON.stringify(obj);
    const def = pako.deflate(json, { level: 9 });
    return Z85.encoder(def); // No prefix needed
}

function decompressTiny(str) {
    const raw = Z85.decoder(str);
    const inflated = pako.inflate(raw);
    return JSON.parse(new TextDecoder().decode(inflated));
}

let pc, dc;

/* -------- Display Function ---------- */
function showString(str) {
    document.getElementById("tinyStr").textContent = str;
    document.getElementById("charCount").textContent =
        "Length: " + str.length + " chars";
    new QRCode(document.getElementById("qr"), {
        text: str, width: 220, height: 220
    });
}

/* -------- Host ---------- */
async function startHost() {
    pc = new RTCPeerConnection();
    dc = pc.createDataChannel("x");

    let out = {};

    pc.onicecandidate = e => {
        if (e.candidate && !out.c) {
            const c = e.candidate.candidate.replace("candidate:", "");
            out = {
                u: pc.localDescription.sdp.match(/ice-ufrag:(.+)/)[1],
                p: pc.localDescription.sdp.match(/ice-pwd:(.+)/)[1],
                c
            };

            const tiny = compressTiny(out);
            showString(tiny);
        }
    };

    const offer = await pc.createOffer();
    await pc.setLocalDescription(offer);
}

/* -------- Join ---------- */
async function startJoin() {
    pc = new RTCPeerConnection();
    pc.ondatachannel = e => {
        dc = e.channel;
        dc.onmessage = m => console.log("Msg:", m.data);
    };
}

/* -------- Apply Remote ---------- */
async function applyRemote() {
    const tiny = document.getElementById("remoteStr").value.trim();
    if (!tiny) return alert("Empty");

    const data = decompressTiny(tiny);

    let sdp;
    if (document.getElementById("hostBtn").disabled) {
        // HOST receives ANSWER
        sdp = buildAnswerSDP(data.u, data.p, data.c);
        await pc.setRemoteDescription({ type: "answer", sdp });
    } else {
        // JOIN receives OFFER
        sdp = buildOfferSDP(data.u, data.p, data.c);
        await pc.setRemoteDescription({ type: "offer", sdp });
        const ans = await pc.createAnswer();
        await pc.setLocalDescription(ans);

        pc.onicecandidate = e => {
            if (e.candidate) {
                const c = e.candidate.candidate.replace("candidate:", "");
                const out = {
                    u: pc.localDescription.sdp.match(/ice-ufrag:(.+)/)[1],
                    p: pc.localDescription.sdp.match(/ice-pwd:(.+)/)[1],
                    c
                };
                const tiny2 = compressTiny(out);
                showString(tiny2);
            }
        };
    }
}

/* -------- UI Hooks ---------- */
document.getElementById("hostBtn").onclick = () => {
    document.getElementById("hostBtn").disabled = true;
    startHost();
};
document.getElementById("joinBtn").onclick = () => {
    document.getElementById("joinBtn").disabled = true;
    startJoin();
};
document.getElementById("applyBtn").onclick = applyRemote;
</script>

</body>
</html>
