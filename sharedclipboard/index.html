<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Shared Clipboard - WebRTC + QR + Compression</title>

<style>
body {
    font-family: Arial, sans-serif;
    padding: 20px;
}
#qrArea, #videoContainer {
    margin-top: 20px;
    text-align: center;
}
textarea {
    width: 100%;
    height: 150px;
}
button {
    padding: 12px 20px;
    margin: 5px;
    font-size: 16px;
}
#video {
    width: 300px;
}
</style>

<!-- QR Code Generator -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

<!-- jsQR Scanner -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jsqr/1.4.0/jsQR.min.js"></script>

<!-- Compression Library -->
<script src="https://cdn.jsdelivr.net/npm/pako@2.1.0/dist/pako.min.js"></script>

</head>
<body>

<h2>Shared Clipboard (WebRTC + QR)</h2>

<button onclick="startHost()">Start as Host</button>
<button onclick="startClient()">Start as Client</button>

<h3>Your Clipboard</h3>
<textarea id="localText"></textarea>
<button onclick="sendMessage()">Send</button>

<h3>Received</h3>
<textarea id="remoteText"></textarea>

<div id="qrArea"></div>

<div id="videoContainer">
    <video id="video" autoplay></video>
    <canvas id="canvas" width="300" height="300" style="display:none;"></canvas>
</div>

<script>
// ------------------------------------------------------------
// Utility: SDP compression
// ------------------------------------------------------------
function encodeSDP(obj) {
    const json = JSON.stringify(obj);
    const bytes = new TextEncoder().encode(json);
    const compressed = pako.deflate(bytes);
    const b64 = btoa(String.fromCharCode(...compressed));
    return "SC:" + b64;
}

function decodeSDP(str) {
    const b64 = str.replace("SC:", "");
    const bin = atob(b64);
    const bytes = Uint8Array.from(bin, c => c.charCodeAt(0));
    const decompressed = pako.inflate(bytes);
    const json = new TextDecoder().decode(decompressed);
    return JSON.parse(json);
}

// ------------------------------------------------------------
// WebRTC
// ------------------------------------------------------------
let pc;
let channel;
let isHost = false;

function createPeerConnection() {
    pc = new RTCPeerConnection({ iceServers: [] });

    pc.ondatachannel = (ev) => {
        channel = ev.channel;
        channel.onmessage = (msg) => {
            remoteText.value = msg.data;
        };
    };

    pc.onicecandidate = () => {
        if (pc.iceGatheringState === "complete") {
            if (isHost) generateOfferQR();
            else generateAnswerQR();
        }
    };
}

async function startHost() {
    isHost = true;
    createPeerConnection();
    channel = pc.createDataChannel("clip");

    const offer = await pc.createOffer();
    await pc.setLocalDescription(offer);
}

async function startClient() {
    isHost = false;
    createPeerConnection();
    startQRScanner();
}

async function applyRemoteDescription(sdpObj) {
    await pc.setRemoteDescription(sdpObj);

    if (!isHost) {
        const answer = await pc.createAnswer();
        await pc.setLocalDescription(answer);
    }
}

// ------------------------------------------------------------
// QR Generation
// ------------------------------------------------------------
function showQR(text) {
    qrArea.innerHTML = "";
    new QRCode(qrArea, {
        text: text,
        width: 256,
        height: 256
    });
}

function generateOfferQR() {
    const small = encodeSDP(pc.localDescription);
    showQR(small);
}

function generateAnswerQR() {
    const small = encodeSDP(pc.localDescription);
    showQR(small);
}

// ------------------------------------------------------------
// Send clipboard message
// ------------------------------------------------------------
function sendMessage() {
    if (channel && channel.readyState === "open") {
        channel.send(localText.value);
    }
}

// ------------------------------------------------------------
// QR Scanner
// ------------------------------------------------------------
let scanning = false;
const video = document.getElementById("video");
const canvas = document.getElementById("canvas");
const ctx = canvas.getContext("2d");

async function startQRScanner() {
    scanning = true;
    qrArea.innerHTML = "<p>Scan Host QR</p>";

    const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } });
    video.srcObject = stream;

    requestAnimationFrame(scanLoop);
}

function scanLoop() {
    if (!scanning) return;

    canvas.width = video.videoWidth;
    canvas.height = video.videoHeight;
    ctx.drawImage(video, 0, 0);

    const imgData = ctx.getImageData(0, 0, canvas.width, canvas.height);
    const code = jsQR(imgData.data, imgData.width, imgData.height);

    if (code) {
        scanning = false;
        video.srcObject.getTracks().forEach(t => t.stop());

        const decoded = decodeSDP(code.data);
        applyRemoteDescription(decoded);
    } else {
        requestAnimationFrame(scanLoop);
    }
}

</script>
</body>
</html>
